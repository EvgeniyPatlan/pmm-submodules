#!/bin/bash

set -o errexit
set -o xtrace

. $(dirname $0)/vars

if [ -f "${docker_tarball}" ]; then
    echo skip docker build
    exit 0
fi

docker run --rm -v ${rpms_dir}:/home/builder/rpm/RPMS perconalab/rpmbuild sh -c "
    sudo chown -R builder /home/builder/rpm/RPMS
    /usr/bin/createrepo_c --update /home/builder/rpm/RPMS
"
cp ${root_dir}/build/pmm-server-docker/* ${rpms_dir}/../
mkdir -p $(dirname $docker_tarball)

docker build --squash --no-cache -t perconalab/pmm-server:${branch} ${rpms_dir}/../

if [ -n "$SAVE_DOCKER" ]; then
    docker save perconalab/pmm-server:${branch} | xz > $docker_tarball
fi
