#!/bin/bash

set -o errexit
set -o xtrace

. $(dirname $0)/vars

if [ -f "${docker_tarball}" ]; then
    echo skip docker build
    exit 0
fi

cp ${root_dir}/build/pmm-server-docker/* ${rpms_dir}/../
docker run --rm -v ${rpms_dir}:/home/builder/rpm/RPMS perconalab/rpmbuild sh -c "
    sudo chown -R builder /home/builder/rpm/RPMS
    /usr/bin/createrepo_c --update /home/builder/rpm/RPMS
"

if [ -z "${DOCKER_TAG}" ]; then
    DOCKER_TAG=perconalab/pmm-server-fb:${pmm_version}
fi
docker build --squash --no-cache -t ${DOCKER_TAG} ${rpms_dir}/../

if [ -n "${PUSH_DOCKER}" ]; then
    mkdir -p $(dirname ${docker_tag_file})
    echo ${DOCKER_TAG} > ${docker_tag_file}
    docker push ${DOCKER_TAG}
fi
if [ -n "${SAVE_DOCKER}" ]; then
    mkdir -p $(dirname ${docker_tarball})
    docker save ${DOCKER_TAG} | xz > ${docker_tarball}
fi
