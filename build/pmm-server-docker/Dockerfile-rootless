FROM centos:7

EXPOSE 8443

WORKDIR /opt

RUN useradd -s /bin/false pmm
RUN yum -y install epel-release && yum -y install ansible

COPY RPMS /tmp/RPMS
COPY gitCommit /tmp/gitCommit
COPY playbook-install.yml /opt/playbook-install.yml
RUN ansible-playbook -vvv -i 'localhost,' -c local /opt/playbook-install.yml

COPY playbook-init.yml /opt/playbook-init.yml
RUN ansible-playbook -vvv -i 'localhost,' -c local /opt/playbook-init.yml
RUN cp /usr/share/pmm-server/entrypoint.sh /opt/entrypoint.sh

COPY supervisord.conf-rootless /etc/supervisord.d/pmm.ini
COPY entrypoint.sh-rootless /opt/entrypoint.sh
RUN sed -i -e 's^unix:///var/run/supervisor/supervisor.sock^unix:///tmp/supervisord.sock^' /etc/supervisord.conf
RUN sed -i -e 's^80^8080^; s^443^8443^' /etc/nginx/conf.d/pmm.conf
RUN sed -i -e 's^/run/nginx.pid^/var/run/nginx/nginx.pid^' /etc/nginx/nginx.conf
RUN install -d -o pmm -g pmm \
    /var/run/nginx

RUN touch \
    /var/log/mysql.log \
    /var/log/consul.log \
    /var/log/nginx.log \
    /var/log/cron.log \
    /var/log/qan-api.log \
    /var/log/prometheus.log \
    /var/log/prometheus1.log \
    /var/log/createdb.log \
    /var/log/createdb2.log \
    /var/log/createdb3.log \
    /var/log/orchestrator.log \
    /var/log/dashboard-upgrade.log \
    /var/log/node_exporter.log \
    /var/log/pmm-manage.log \
    /var/log/pmm-managed.log

RUN chown -R pmm:pmm \
    /etc/grafana \
    /etc/supervisord.d/pmm.ini \
    /etc/prometheus.yml \
    /etc/orchestrator.conf.json \
    /etc/cron.daily/purge-qan-data \
    /var/lib \
    /opt \
    /srv \
    /var/run/mysqld \
    /var/lib/nginx \
    /var/lib/mysql \
    /var/lib/grafana \
    /var/log/nginx \
    /var/log/grafana \
    /var/log/supervisor \
    /var/log/mysql.log \
    /var/log/consul.log \
    /var/log/nginx.log \
    /var/log/cron.log \
    /var/log/qan-api.log \
    /var/log/prometheus.log \
    /var/log/prometheus1.log \
    /var/log/createdb.log \
    /var/log/createdb2.log \
    /var/log/createdb3.log \
    /var/log/orchestrator.log \
    /var/log/dashboard-upgrade.log \
    /var/log/node_exporter.log \
    /var/log/pmm-manage.log \
    /var/log/pmm-managed.log

USER pmm

CMD ["/opt/entrypoint.sh"]
